<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Test</title>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .stat-card__value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0;
        }
        
        .stat-card--primary .stat-card__value { color: #2563eb; }
        .stat-card--success .stat-card__value { color: #059669; }
        .stat-card--info .stat-card__value { color: #0ea5e9; }
        .stat-card--warning .stat-card__value { color: #d97706; }
        
        .stat-card__label {
            font-size: 0.875rem;
            color: #6b7280;
            margin: 0.5rem 0 0 0;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .stat-card__detail {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 0.25rem;
        }
        
        .progress-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .progress-bar {
            height: 1.5rem;
            background: #f3f4f6;
            border-radius: 9999px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-bar__fill {
            height: 100%;
            background: linear-gradient(90deg, #2563eb, #3b82f6);
            border-radius: 9999px;
            transition: width 0.5s ease;
        }
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
    </style>
</head>
<body>
    <h1>Dashboard Statistics Test</h1>
    
    <!-- ARIA live regions -->
    <div id="status-messages" aria-live="polite" aria-atomic="true" class="sr-only"></div>
    <div id="error-messages" aria-live="assertive" aria-atomic="true" class="sr-only"></div>
    
    <div id="dashboard-content">
        <!-- Statistics will be rendered here -->
    </div>
    
    <script>
        // Mock data for testing
        const mockTasks = [
            {
                id: 'task1',
                title: 'Complete JavaScript Assignment',
                dueDate: '2025-01-15',
                duration: 120,
                tag: 'Programming',
                status: 'Complete',
                createdAt: '2025-01-10T10:00:00Z',
                updatedAt: '2025-01-12T14:30:00Z'
            },
            {
                id: 'task2',
                title: 'Study for Math Exam',
                dueDate: '2025-01-16',
                duration: 180,
                tag: 'Mathematics',
                status: 'Pending',
                createdAt: '2025-01-11T09:00:00Z',
                updatedAt: '2025-01-11T09:00:00Z'
            },
            {
                id: 'task3',
                title: 'Write History Essay',
                dueDate: '2025-01-14',
                duration: 90,
                tag: 'History',
                status: 'Complete',
                createdAt: '2025-01-09T16:00:00Z',
                updatedAt: '2025-01-13T20:15:00Z'
            },
            {
                id: 'task4',
                title: 'Programming Project',
                dueDate: '2025-01-17',
                duration: 240,
                tag: 'Programming',
                status: 'Pending',
                createdAt: '2025-01-08T11:00:00Z',
                updatedAt: '2025-01-08T11:00:00Z'
            }
        ];
        
        const mockSettings = {
            weeklyHourTarget: 40
        };
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function renderDashboardStats() {
            const tasks = mockTasks;
            const settings = mockSettings;
            
            // Calculate basic statistics
            const totalTasks = tasks.length;
            const completedTasks = tasks.filter(task => task.status === 'Complete').length;
            const pendingTasks = tasks.filter(task => task.status === 'Pending').length;
            
            // Calculate total hours planned (all tasks)
            const totalHoursPlanned = tasks.reduce((sum, task) => sum + (task.duration || 0), 0) / 60;
            
            // Calculate completed hours
            const completedHours = tasks
              .filter(task => task.status === 'Complete')
              .reduce((sum, task) => sum + (task.duration || 0), 0) / 60;
            
            // Get most common tag (top tag)
            const tagCounts = {};
            tasks.forEach(task => {
              const tag = task.tag || 'General';
              tagCounts[tag] = (tagCounts[tag] || 0) + 1;
            });
            
            let topTag = 'None';
            let maxCount = 0;
            Object.entries(tagCounts).forEach(([tag, count]) => {
              if (count > maxCount) {
                maxCount = count;
                topTag = tag;
              }
            });
            
            // Calculate upcoming tasks for current week
            const today = new Date();
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay());
            currentWeekStart.setHours(0, 0, 0, 0);
            
            const currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
            currentWeekEnd.setHours(23, 59, 59, 999);
            
            const upcomingThisWeek = tasks.filter(task => {
              if (task.status !== 'Pending') return false;
              const dueDate = new Date(task.dueDate);
              return dueDate >= currentWeekStart && dueDate <= currentWeekEnd;
            }).length;
            
            // Calculate overdue tasks
            const overdueTasks = tasks.filter(task => {
              if (task.status !== 'Pending') return false;
              const dueDate = new Date(task.dueDate);
              const todayStart = new Date();
              todayStart.setHours(0, 0, 0, 0);
              return dueDate < todayStart;
            }).length;
            
            return `
              <div class="stats-grid">
                <div class="stat-card stat-card--primary">
                  <div class="stat-card__value">${totalTasks}</div>
                  <div class="stat-card__label">Total Tasks</div>
                  <div class="stat-card__detail">${pendingTasks} pending</div>
                </div>
                
                <div class="stat-card stat-card--success">
                  <div class="stat-card__value">${totalHoursPlanned.toFixed(1)}h</div>
                  <div class="stat-card__label">Total Hours Planned</div>
                  <div class="stat-card__detail">${completedHours.toFixed(1)}h completed</div>
                </div>
                
                <div class="stat-card stat-card--info">
                  <div class="stat-card__value">${escapeHtml(topTag)}</div>
                  <div class="stat-card__label">Top Category</div>
                  <div class="stat-card__detail">${maxCount} task${maxCount !== 1 ? 's' : ''}</div>
                </div>
                
                <div class="stat-card ${upcomingThisWeek > 0 ? 'stat-card--warning' : 'stat-card--neutral'}">
                  <div class="stat-card__value">${upcomingThisWeek}</div>
                  <div class="stat-card__label">This Week</div>
                  <div class="stat-card__detail">
                    ${overdueTasks > 0 ? `${overdueTasks} overdue` : 'On track'}
                  </div>
                </div>
              </div>
            `;
        }
        
        function renderProgressChart() {
            const tasks = mockTasks;
            const settings = mockSettings;
            const weeklyTarget = settings.weeklyHourTarget || 40;
            
            // Calculate current week progress
            const today = new Date();
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay());
            currentWeekStart.setHours(0, 0, 0, 0);
            
            const currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
            currentWeekEnd.setHours(23, 59, 59, 999);
            
            // Calculate hours from completed tasks in current week
            const currentWeekCompletedHours = tasks
              .filter(task => {
                if (task.status !== 'Complete') return false;
                const completedDate = new Date(task.updatedAt || task.createdAt);
                return completedDate >= currentWeekStart && completedDate <= currentWeekEnd;
              })
              .reduce((sum, task) => sum + (task.duration || 0), 0) / 60;
            
            const progressPercentage = Math.min((currentWeekCompletedHours / weeklyTarget) * 100, 100);
            const isOverTarget = currentWeekCompletedHours > weeklyTarget;
            const remainingHours = Math.max(weeklyTarget - currentWeekCompletedHours, 0);
            
            // Determine progress status for ARIA announcements
            let progressStatus = '';
            let ariaLive = 'polite';
            
            if (isOverTarget) {
              progressStatus = `Alert: You have exceeded your weekly target by ${(currentWeekCompletedHours - weeklyTarget).toFixed(1)} hours.`;
              ariaLive = 'assertive';
            } else if (currentWeekCompletedHours > 0) {
              progressStatus = `You have completed ${currentWeekCompletedHours.toFixed(1)} hours of your ${weeklyTarget} hour weekly target. ${remainingHours.toFixed(1)} hours remaining.`;
            } else {
              progressStatus = `Weekly target: ${weeklyTarget} hours. No hours completed yet this week.`;
            }
            
            return `
              <div class="progress-card">
                <h3>Weekly Progress</h3>
                
                <!-- ARIA live region for progress announcements -->
                <div 
                  id="progress-announcements" 
                  aria-live="${ariaLive}" 
                  aria-atomic="true" 
                  class="sr-only"
                >
                  ${progressStatus}
                </div>
                
                <div class="progress-bar">
                  <div class="progress-bar__fill" style="width: ${progressPercentage}%"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                  <span>${currentWeekCompletedHours.toFixed(1)}h completed</span>
                  <span>${weeklyTarget}h target</span>
                  <span>${progressPercentage.toFixed(0)}%</span>
                </div>
                
                ${isOverTarget ? `
                  <div style="background: #fffbeb; border-left: 4px solid #d97706; padding: 1rem; margin-top: 1rem; border-radius: 4px;">
                    <strong>⚠️ Target Exceeded:</strong> 
                    You've completed ${(currentWeekCompletedHours - weeklyTarget).toFixed(1)} hours over your weekly target.
                  </div>
                ` : ''}
              </div>
            `;
        }
        
        function announceProgressUpdate() {
            const statusElement = document.getElementById('status-messages');
            const errorElement = document.getElementById('error-messages');
            
            const tasks = mockTasks;
            const settings = mockSettings;
            const weeklyTarget = settings.weeklyHourTarget || 40;
            
            // Calculate current week progress
            const today = new Date();
            const currentWeekStart = new Date(today);
            currentWeekStart.setDate(today.getDate() - today.getDay());
            currentWeekStart.setHours(0, 0, 0, 0);
            
            const currentWeekEnd = new Date(currentWeekStart);
            currentWeekEnd.setDate(currentWeekStart.getDate() + 6);
            currentWeekEnd.setHours(23, 59, 59, 999);
            
            const currentWeekCompletedHours = tasks
              .filter(task => {
                if (task.status !== 'Complete') return false;
                const completedDate = new Date(task.updatedAt || task.createdAt);
                return completedDate >= currentWeekStart && completedDate <= currentWeekEnd;
              })
              .reduce((sum, task) => sum + (task.duration || 0), 0) / 60;
            
            const isOverTarget = currentWeekCompletedHours > weeklyTarget;
            const remainingHours = Math.max(weeklyTarget - currentWeekCompletedHours, 0);
            
            if (isOverTarget) {
              const overHours = (currentWeekCompletedHours - weeklyTarget).toFixed(1);
              const message = `Alert: Weekly target exceeded by ${overHours} hours. Total completed: ${currentWeekCompletedHours.toFixed(1)} hours.`;
              errorElement.textContent = message;
              setTimeout(() => { errorElement.textContent = ''; }, 3000);
            } else if (currentWeekCompletedHours > 0) {
              const message = `Weekly progress updated. ${currentWeekCompletedHours.toFixed(1)} of ${weeklyTarget} hours completed. ${remainingHours.toFixed(1)} hours remaining.`;
              statusElement.textContent = message;
              setTimeout(() => { statusElement.textContent = ''; }, 1000);
            }
        }
        
        // Render the dashboard
        document.getElementById('dashboard-content').innerHTML = 
            renderDashboardStats() + renderProgressChart();
        
        // Test the announcement
        setTimeout(() => {
            announceProgressUpdate();
        }, 1000);
        
        console.log('Dashboard test loaded successfully');
        console.log('Mock tasks:', mockTasks);
        console.log('Statistics calculated and rendered');
    </script>
</body>
</html>